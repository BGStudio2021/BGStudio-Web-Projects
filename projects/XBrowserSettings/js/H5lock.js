window.H5lock=function(t){this.height=t.height,this.width=t.width,this.panelId=t.panelId,this.chooseType=Number(window.localStorage.getItem("chooseType"))||t.chooseType,this._str_set_unlock_pattern_for_first=t._str_set_unlock_pattern_for_first||"首次使用设定解锁图案",this._str_passwd_saved=t._str_passwd_saved||"密码保存成功",this._str_input_not_match=t._str_input_not_match||"两次不一致，重新输入",this._str_unlocked=t._str_unlocked||"解锁成功",this._str_unlock_failed=t._str_unlock_failed||"解锁失败",this._str_input_again=t._str_input_again||"再次输入",this._str_pls_unlock=t._str_pls_unlock||"请解锁",this._str_draw_unlock_pattern=t._str_draw_unlock_pattern||"请绘制解锁图案"},H5lock.prototype.drawCle=function(t,s){this.ctx.strokeStyle="#CFE6FF",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(t,s,this.r,0,2*Math.PI,!0),this.ctx.closePath(),this.ctx.stroke()},H5lock.prototype.drawPoint=function(){for(var t=0;t<this.lastPoint.length;t++)this.ctx.fillStyle="#CFE6FF",this.ctx.beginPath(),this.ctx.arc(this.lastPoint[t].x,this.lastPoint[t].y,this.r/2,0,2*Math.PI,!0),this.ctx.closePath(),this.ctx.fill()},H5lock.prototype.drawStatusPoint=function(t){for(var s=0;s<this.lastPoint.length;s++)this.ctx.strokeStyle=t,this.ctx.beginPath(),this.ctx.arc(this.lastPoint[s].x,this.lastPoint[s].y,this.r,0,2*Math.PI,!0),this.ctx.closePath(),this.ctx.stroke()},H5lock.prototype.dispatch=function(t,s){var e=document.createEvent("CustomEvent");return e&&e.initCustomEvent?e.initCustomEvent("locker:"+t,!0,!0,s):((e=document.createEvent("Event")).initEvent("locker:"+t,!0,!0),e.detail=s),this.target.dispatchEvent(e)},H5lock.prototype.drawLine=function(t,s){this.ctx.beginPath(),this.ctx.lineWidth=3,this.ctx.moveTo(this.lastPoint[0].x,this.lastPoint[0].y),console.log(this.lastPoint.length);for(var e=1;e<this.lastPoint.length;e++)this.ctx.lineTo(this.lastPoint[e].x,this.lastPoint[e].y);this.ctx.lineTo(t.x,t.y),this.ctx.stroke(),this.ctx.closePath()},H5lock.prototype.createCircle=function(){for(var t=this.chooseType,s=0,e=(this.r=this.ctx.canvas.width/(2+4*t),this.lastPoint=[],this.arr=[],this.restPoint=[],this.r),i=0;i<t;i++)for(var n=0;n<t;n++){var o={x:4*n*e+3*e,y:4*i*e+3*e,index:++s};this.arr.push(o),this.restPoint.push(o)}this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height);for(i=0;i<this.arr.length;i++)this.drawCle(this.arr[i].x,this.arr[i].y)},H5lock.prototype.getPosition=function(t){var s=t.currentTarget.getBoundingClientRect();return{x:t.touches[0].clientX-s.left,y:t.touches[0].clientY-s.top}},H5lock.prototype.update=function(t){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height);for(var s=0;s<this.arr.length;s++)this.drawCle(this.arr[s].x,this.arr[s].y);this.drawPoint(this.lastPoint),this.drawLine(t,this.lastPoint);for(s=0;s<this.restPoint.length;s++)if(Math.abs(t.x-this.restPoint[s].x)<this.r&&Math.abs(t.y-this.restPoint[s].y)<this.r){this.drawPoint(this.restPoint[s].x,this.restPoint[s].y),this.lastPoint.push(this.restPoint[s]),this.restPoint.splice(s,1);break}},H5lock.prototype.checkPass=function(t,s){for(var e="",i="",n=0;n<t.length;n++)e+=t[n].index+t[n].index;for(n=0;n<s.length;n++)i+=s[n].index+s[n].index;return e===i},H5lock.prototype.storePass=function(t){1==this.pswObj.step?this.checkPass(this.pswObj.fpassword,t)?(this.pswObj.step=2,this.pswObj.spassword=t,document.getElementById("title").innerHTML=this._str_passwd_saved,this.drawStatusPoint("#2CFF26"),mbrowser.setUnlockPasswd(JSON.stringify(this.pswObj.spassword)),this.dispatch("passwdchanged")):(document.getElementById("title").innerHTML=this._str_input_not_match,this.drawStatusPoint("red"),delete this.pswObj.step):2==this.pswObj.step?this.checkPass(this.pswObj.spassword,t)?(document.getElementById("title").innerHTML=this._str_unlocked,this.drawStatusPoint("#2CFF26"),this.dispatch("unlocked"),console.log(">>>>>>>>>> unlocked >>>>>>>>>>>>")):(this.drawStatusPoint("red"),document.getElementById("title").innerHTML=this._str_unlock_failed):(this.pswObj.step=1,this.pswObj.fpassword=t,document.getElementById("title").innerHTML=this._str_input_again)},H5lock.prototype.makeState=function(){2==this.pswObj.step?(document.getElementById("title").innerHTML=this._str_pls_unlock,document.getElementById("updatePassword").style.display="none"):1!=this.pswObj.step&&0==this.pswObj.step?(document.getElementById("updatePassword").style.display="none",document.getElementById("title").innerHTML=this._str_set_unlock_pattern_for_first):document.getElementById("updatePassword").style.display="none"},H5lock.prototype.setChooseType=function(t){chooseType=t,init()},H5lock.prototype.updatePassword=function(){mbrowser.setUnlockPasswd("{}"),this.pswObj={},document.getElementById("title").innerHTML=this._str_draw_unlock_pattern,this.reset()},H5lock.prototype.initDom=function(){var t=document.createElement("div"),s=(t.innerHTML='<canvas id="canvas" width="320" height="320" style="background-color: #305066;display: inline-block;margin-top: 30%;"></canvas>',document.querySelector("#"+this.panelId));(this.target=s).appendChild(t)},H5lock.prototype.init=function(){this.initDom(),console.log(">>>> passwd:"+mbrowser.getUnlockPasswd());var t=mbrowser.getUnlockPasswd(),s="{}"!=t?2:0;this.pswObj={},this.pswObj.spassword=JSON.parse(t),this.pswObj.step=s,this.lastPoint=[],this.makeState(),this.touchFlag=!1,this.canvas=document.getElementById("canvas"),this.ctx=this.canvas.getContext("2d"),this.createCircle(),this.bindEvent()},H5lock.prototype.reset=function(){this.makeState(),this.createCircle()},H5lock.prototype.bindEvent=function(){var i=this;this.canvas.addEventListener("touchstart",function(t){t.preventDefault();var s=i.getPosition(t);console.log(s);for(var e=0;e<i.arr.length;e++)if(Math.abs(s.x-i.arr[e].x)<i.r&&Math.abs(s.y-i.arr[e].y)<i.r){i.touchFlag=!0,i.drawPoint(i.arr[e].x,i.arr[e].y),i.lastPoint.push(i.arr[e]),i.restPoint.splice(e,1);break}},!1),this.canvas.addEventListener("touchmove",function(t){i.touchFlag&&i.update(i.getPosition(t))},!1),this.canvas.addEventListener("touchend",function(t){i.touchFlag&&(i.touchFlag=!1,i.storePass(i.lastPoint),setTimeout(function(){i.reset()},300))},!1)};