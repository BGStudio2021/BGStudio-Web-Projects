var next_page_pattern=["next","下一页","下页","下一篇","下一章","下篇","下章","后一篇"];function match_next_page_pattern(e){try{for(var t=0;t<next_page_pattern.length;t++){var n=next_page_pattern[t];if(0<=e.innerHTML.indexOf(n))return!0}for(var r=e.getAttributeNames(),o=0;o<r.length;o++)if(0<=e.getAttribute(r[o]).toLowerCase().indexOf("next"))return!0}catch(e){return console.log(e.toString()),!1}return!1}function sniff_next_page(){for(var e=null,t=document.querySelectorAll("a"),n=0;n<t.length;n++){var r=t[n];if(match_next_page_pattern(r)){e=r.href;break}}return e}function remove_tag_script(e){var t=e.querySelectorAll("script");if(t)for(var n=0;n<t.length;n++){var r=t[n];r.parentNode.removeChild(r)}}function extract_content_node(){for(var e=null,t=document.querySelectorAll("p"),n="",r=0;r<t.length;r++){var o=t[r];if(0!=o.offsetHeight){var l=o.parentNode;if(console.log(">>>>>> p height:"+o.offsetHeight+" parent height:"+l.offsetHeight+" tagName"+l.tagName+" class:"+l.className),(l&&600<l.offsetHeight||600<o.offsetHeight)&&"body"!=l.tagName.toLowerCase()){if(e=l,console.log("====================== height  and content ====================="),(n=e.innerHTML.replace(/<[^>]+>/g,"")).length<200)continue;break}console.log("==================== continue parse ===================")}}if(null==e)for(var i=document.querySelectorAll("br"),r=0;r<i.length;r++)if((l=i[r].parentNode)&&600<l.offsetHeight){n=(e=l).innerHTML.replace(/<[^>]+>/g,"");break}if(null==e)for(var a=document.querySelectorAll("div"),r=0;r<a.length;r++){var c=a[r];if(800<c.offsetHeight&&600<c.innerHTML.length){n=(e=c).innerHTML.replace(/<[^>]+>/g,"");break}}if(null!=e){if(5<=e.querySelectorAll("li").length)return console.log("============= too many li tags ================="),null;if(n.length<360)return console.log("============= too little text words ================="+n.length),null;var g=e.querySelectorAll("a");if(console.log(">>>>>>>>>>>>>>> hres count: "+g.length),25<=g.length)return null}return e||null}function include_topic_image(e){if(console.log(" #### node offset height:"+e.offsetHeight+" name: "+e.tagName),"img"==e.tagName.toLowerCase()){if(console.log("###### find  img on "+e.parentNode.tagName),200<=e.width&&240<=e.height)return!0;if(100<=e.width&&300<e.height)return!0}else{e=e.querySelector("img");if(e){if(200<=e.width&&240<=e.height)return console.log(">>>>>>#### include img:"+e.height+" w:"+e.width+"src"+e.src),!0;if(100<=e.width&&300<e.height)return!0;console.log(">>>>>>#### not valid img:"+e.height+" w:"+e.width+"src"+e.src)}}return!1}function remove_non_text_tag(e){for(var t=[],n=e.children,r=0;r<n.length;r++){var o=n[r],l=(console.log(">>>>>>>> look up:tag "+o.tagName+" class:"+o.className+"tag height:"+o.offsetHeight),o.tagName.toLowerCase());if("p"!=l&&"br"!=l&&"span"!=l)if(include_topic_image(o))console.log(">>>>>>>>>>>>>>>>  keep this tag"+o.tagName+" tag width"+o.width);else{l=o.querySelector("p");if(console.log("======== conteng:"+o.tagName+"tag offset:"+o.offsetHeight),l){if(600<o.innerHTML.length)continue;if(500<=o.offsetHeight&&o.innerHTML.indexOf("广告")<0)continue}o.querySelector("br")&&o.innerHTML.indexOf("广告")<0||t.push(o)}}for(r=0;r<t.length;r++){o=t[r];console.log("=================== remove tags: "+o.tagName+" class: "+o.className),console.log("remove content:"+o.innerHTML),e.removeChild(o)}}function maybe_is_title(e){if(e.childElementCount<=2)for(var t in e){var n=e[t];if("string"==typeof e[t]&&n&&n.length<20&&0<=n.indexOf("title"))return console.log("==== match attr_name:"+t+" attr_value:"+n),!0}return!1}function try_get_title(e){try{var t=document.querySelector("article");if(t){var n=t.querySelector("h1");if(n&&0<n.offsetHeight)return n.innerHTML;if((n=t.querySelector("h2"))&&0<n.offsetHeight)return n.innerHTML;if((n=t.querySelector("h3"))&&0<n.offsetHeight)return n.innerHTML;if((n=t.querySelector("h4"))&&0<n.offsetHeight)return n.innerHTML}if(console.log("============ next step ================== "),!e.tagName)return;var r=e.tagName.toLowerCase();if(console.log("=== try_get_title:"+r+" class:"+e.className),"h1"==r||"h2"==r||"h3"==r||"h4"==r)return e.innerHTML;var o=e.querySelector("h1");if(!(o=(o=!(o=!(o=!o||0==o.offsetHeight?e.querySelector("h2"):o)||0==o.offsetHeight?e.querySelector("h3"):o)||0==o.offsetHeight?e.querySelector("h4"):o)&&0==o.offsetHeight?null:o)&&maybe_is_title(e))return e.innerHTML;for(var l=0;l<e.children.length;l++){var i=e.children[l];if(maybe_is_title(i))return i.innerHTML}if(console.log("================ try travel with pre node ================="),o)return o.innerHTML;var a=e.previousElementSibling;if(a)return console.log(">>>>> try pre_node:"+a.tagName+" class:"+a.className),try_get_title(a);var c=e.parentNode;if(c)return console.log(">>>>> try parent_node:"+c.tagName+" class:"+c.className),try_get_title(c)}catch(e){if(console.log(e.toString()),o=document.querySelector("title"))return o.innerHTML}return null}function travel_and_rewrite(e){e.tagName.toLowerCase();if(0!=e.childElementCount)for(var t=0;t<e.children.length;t++)travel_and_rewrite(e.children[t])}function clone_and_filter(e){var t=e.childNodes.length;if(0==t)return(n=e.cloneNode())&&n.nodeType==n.ELEMENT_NODE&&(n.removeAttribute("class"),n.removeAttribute("style"),n.removeAttribute("width"),n.removeAttribute("height")),n;for(var n=e.tagName,r=(0<n.indexOf("=")&&(n="div"),document.createElement(n)),o=0;o<t;o++){var l=e.childNodes[o];if(l.nodeType==l.ELEMENT_NODE){var i=l.tagName.toLowerCase();if("img"==i){if(l.offsetHeight<150)continue}else{if("script"==i)continue;if("style"==i)continue}}r.appendChild(clone_and_filter(l))}return r}!function(){try{console.log("================ start extract text content ============================");var e,t,n,r,o,l=extract_content_node();l?(console.log("=============  content tag:"+l.tagName+" class name:"+l.className),e=try_get_title(l),console.warn(">>>>> article title is:"+e),console.log("==============  try get content =============="),travel_and_rewrite(l),t=clone_and_filter(l),console.log("==============  dump content instance  =============="),console.log("==============  the man content name: =============="+l.tagName+" class:"+l.className+"content height:"+t.offsetHeight),remove_non_text_tag(t),n=t.innerHTML,r=sniff_next_page(),console.log("==============  the man content =============="),o=(o=n.replace(/<[^>]+>/g,"")).replace(/\s*/g,""),e&&200<o.length&&l?(console.log(">>>>found next_url:"+r),mbrowser.pushToCache(e,n,r)):mbrowser.notifyParseContentFailed(),setTimeout(function(){var e=sniff_next_page();e&&mbrowser.updateNextUrlForActivePage(e)},1e3)):mbrowser.notifyParseContentFailed()}catch(e){console.log(e.toString())}}();